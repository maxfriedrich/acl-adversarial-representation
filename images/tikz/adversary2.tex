%TeX root=adversary1-standalone

\begin{tikzpicture}[node distance=1.8cm,font=\small]
\tikzset{every node/.style={inner sep=1mm, outer sep=0mm, line width=0mm}}

\tikzstyle{token}=[rectangle,draw=black,fill=white,semithick,text width=1.4cm, minimum width=1.6cm, minimum height=6mm, text height=1.5ex,text depth=.25ex]
\tikzstyle{model}=[rounded rectangle,draw=black,fill=white,semithick, minimum width=3cm, minimum height=10mm, text height=1.5ex,text depth=.25ex, inner sep=2mm]
\tikzstyle{dots} = []
\tikzstyle{vector} = [draw, shape=rectangle, fill=white, semithick, minimum width=1.6cm, minimum height=4mm]
\tikzstyle{red vector} = [draw=red, shape=rectangle, fill=white, semithick, minimum width=1.6cm, minimum height=4mm]
\tikzstyle{half vector} = [shape=rectangle, semithick, minimum width=1.6cm, minimum height=4mm] % without drawn border
\tikzstyle{two thirds vector} = [draw, shape=rectangle, fill=white, semithick, minimum width=1.2cm, minimum height=4mm]
\tikzstyle{quarter vector} = [draw, shape=rectangle, fill=white, semithick, minimum width=4mm, minimum height=4mm]
\tikzstyle{pre}=[<-,semithick, >=latex]
\tikzstyle{post}=[->, semithick, >=latex]

% inputs and embeddings
\node[token] (mr input){Mr.};
\node[token, right of=mr input] (smith input) {Smith};
\node[token, right of=smith input] (was input) {was};
\node[dots, right=3mm of was input] (input dots) {$\cdots$};
    
\node[vector, above=9mm of mr input] (mr embedding) {};
\node[vector, right of=mr embedding] (smith embedding) {};
\node[vector, right of=smith embedding] (was embedding) {};
\node[dots, right=3mm of was embedding] (embedding dots) {$\cdots$};

\begin{scope}[on background layer]
    \node (input box) [draw,fill=black!5,fit=(mr input) (input dots), inner sep=2.5mm] {};
    \node (feature box) [draw,fill=black!5,fit=(mr embedding) (embedding dots), inner sep=2.5mm] {};
\end{scope}

% inputs2 and embeddings2
\node[token, right= 1cm of input dots] (mr input2){Mr.};
\node[token, draw=red, right of=mr input2] (smith input2) {\textcolor{red}{Collins}};
\node[token, right of=smith input2] (was input2) {was};
\node[dots, right=3mm of was input2] (input2 dots) {$\cdots$};

\node[vector, above=9mm of mr input2] (mr embedding2) {};
\node[red vector, right of=mr embedding2] (smith embedding2) {};
\node[vector, right of=smith embedding2] (was embedding2) {};
\node[dots, right=3mm of was embedding2] (embedding2 dots) {$\cdots$};

\begin{scope}[on background layer]
\node (input2 box) [draw,fill=black!5,fit=(mr input2) (input2 dots), inner sep=2.5mm] {};
\node (feature2 box) [draw,fill=black!5,fit=(mr embedding2) (embedding2 dots), inner sep=2.5mm] {};
\end{scope}

% representation models
\node[model,above=4mm of feature box] (representation model) {Representation Model};
\node[model,above=4mm of feature2 box] (representation2 model) {Representation Model};

% representations
\node[vector, above=2.3cm of mr embedding] (mr representation) {};
\node[vector, right of=mr representation] (smith representation) {};
\node[vector, right of=smith representation] (was representation) {};
\node[dots, right=3mm of was representation] (representation dots) {$\cdots$};

\begin{scope}[on background layer]
    \node (representation box) [draw,fill=black!5,fit=(mr representation) (representation dots), inner sep=2.5mm] {};
\end{scope}

% representations2
\node[red vector, above=2.3cm of mr embedding2] (mr representation2) {};
\node[red vector, right of=mr representation2] (smith representation2) {};
\node[red vector, right of=smith representation2] (was representation2) {};
\node[dots, right=3mm of was representation2] (representation2 dots) {$\cdots$};

\begin{scope}[on background layer]
\node (representation2 box) [draw,fill=black!5,fit=(mr representation2) (representation2 dots), inner sep=2.5mm] {};
\end{scope}

\path (representation box) -- (representation2 box) node[model, midway,above=9mm] (adversary model) {Adversary Model};


\node[quarter vector, above=7mm of adversary model](adversary output) {};

\begin{scope}[on background layer]
    \node (adversary output box) [draw,fill=black!5,fit=(adversary output), inner sep=2.5mm] {};
\end{scope}


% black vector squares
\foreach \i in {mr embedding, smith embedding, was embedding, mr embedding2, was embedding2, mr representation, smith representation, was representation} {
    \draw[semithick] (\i.north west) rectangle ($(\i.north west) + (4mm, -4mm)$);
    \draw[semithick] (\i.north west) rectangle ($(\i.north west) + (8mm, -4mm)$);
    \draw[semithick] (\i.north west) rectangle ($(\i.north west) + (12mm, -4mm)$);    
};

% red vector squares
\foreach \i in {smith embedding2, mr representation2, smith representation2, was representation2} {
    \draw[red,semithick] (\i.north west) rectangle ($(\i.north west) + (4mm, -4mm)$);
    \draw[red,semithick] (\i.north west) rectangle ($(\i.north west) + (8mm, -4mm)$);
    \draw[red,semithick] (\i.north west) rectangle ($(\i.north west) + (12mm, -4mm)$);    
};

\path[post] (input box) edge (feature box);
\path[post] (feature box) edge (representation model);
\path[post] (input2 box) edge (feature2 box);
\path[post] (feature2 box) edge (representation2 model);

\path[post] (representation model) edge (representation box);
\path[post] (representation2 model) edge (representation2 box);
\draw[dotted] (representation model) edge node[fill=white, text height=1.5ex,text depth=.25ex] {copy} (representation2 model);


\path[post] (representation box) edge (adversary model);
\path[post] (representation2 box) edge (adversary model);
\path[post] (adversary model) edge (adversary output box);

\end{tikzpicture}